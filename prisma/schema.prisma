generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id           String   @id @default(uuid()) @db.Uuid
  name         String
  email        String   @unique
  passwordHash String   @map("password_hash")
  createdAt    DateTime @default(now()) @map("created_at")

  leads               Lead[]
  refreshTokens       RefreshToken[]
  externalCredentials ExternalCredential[]
  authLogs            AuthLog[]

  @@map("accounts")
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  token     String   @unique
  accountId String   @map("account_id") @db.Uuid
  account   Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([accountId])
  @@map("refresh_tokens")
}

model Lead {
  id        String   @id @default(uuid()) @db.Uuid
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  email     String
  phone     String?
  company   String?
  source    String   @default("manual")
  status    String   @default("new")
  accountId String   @map("account_id") @db.Uuid
  account   Account  @relation(fields: [accountId], references: [id])
  createdAt DateTime @default(now()) @map("created_at")

  @@index([accountId])
  @@index([status])
  @@map("leads")
}

model ExternalCredential {
  id               String    @id @default(uuid()) @db.Uuid
  accountId        String    @map("account_id") @db.Uuid
  account          Account   @relation(fields: [accountId], references: [id])
  provider         String
  encryptedPayload Bytes     @map("encrypted_payload")
  createdAt        DateTime  @default(now()) @map("created_at")
  rotatedAt        DateTime? @map("rotated_at")

  @@unique([accountId, provider])
  @@index([accountId])
  @@map("external_credentials")
}

model AuthLog {
  id        String   @id @default(uuid()) @db.Uuid
  accountId String   @map("account_id") @db.Uuid
  account   Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  action    String
  metadata  Json?
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([accountId])
  @@map("auth_logs")
}
